@model ReliDemo.ViewModels.StationHistoriesViewModel

@{
    ViewBag.Title = "Graph";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row-fluid">
<div class="span8">
<p>
    @Html.ActionLink("返回热力站列表", "Paged")
</p>
</div>
</div>
<div class="row-fluid clearfix stationTitle">
    <h1 class="span3">@Model.StationName</h1>
    <div onDesktop="span4" onTablet="span6" onMobile="span12">@Html.Partial("_TopMenu")</div>
</div>
<div class="row-fluid stationControl">
    <div class="control-group"  onTablet="span12" onDesktop="span3" >
            <label class="checkbox inline">
                <input type="radio" value="week" name="week" /> 周
            </label>
            <label class="checkbox inline">
                <input type="radio" value="month" name="month"  /> 月
            </label>
            <label class="checkbox inline">
                <input type="radio" value="season" name="season"  /> 供暖季
            </label>
    </div>
    <div class="control-group"  onTablet="span12" onDesktop="span5" >
        <text>选择日期:</text>
        @Html.TextBox("dateFrom", DateTime.Today.AddDays(-7).ToString("yyyy-MM-dd"), new { @style="width:100px" })
        <text>到</text>
        @Html.TextBox("dateTo", DateTime.Today.AddDays(1).ToString("yyyy-MM-dd"), new { @style="width:100px" })
        <input type="submit" value="搜索" id="search" class="btn btn-primary" style="vertical-align: top;"/>
    </div>
	<div class="control-group"   onTablet="span12" onDesktop="span4" >
	<text>折合统一温度</text>
	<input type="text" class="inline" style="width:100px" /><text>℃</text></div>
</div>
<div class="row-fluid">
    <div id="stationgraph" style="width:100%;height:400px">
    </div>
</div>
@Html.HiddenFor(model=>model.StationId)
<script type="text/javascript">

    $(function () {

        var heatoptions = {
            lines: {
                show: true
            },
            points: {
                show: true
            },
            xaxis: {
                mode: "time",
                minTickSize: [1, "day"],
                timeformat: "%m月%d日"
            },
			yaxis: [{},{}],
			legend:{position:"sw"},
			grid : {
            tickColor: "#eee",
            borderWidth: 0,
            hoverable: true,
            clickable: true
        }
        };

        $("#search").click(function () {

            var button = $(this);

            // Find the URL in the link right next to us, then fetch the data

            var dataurl = "HistoryData?stationId=" + $("#StationId").val() + "&from=" + $("#dateFrom").val() + "&to=" + $("#dateTo").val();

            function onDataReceived(series) {
				console.log(series);
                $.plot("#stationgraph", [{"label":"实际平均温度", "data": series.planned, yaxis:2},{"label":"预报平均温度单耗", "data": series.planned }, {"label":"实际单耗",  "data": series.actual }, {"label":"核算单耗",  "data": series.calculated}], heatoptions);
            }

            $.ajax({
                url: dataurl,
                type: "GET",
                dataType: "json",
                success: onDataReceived
            });
        });


        // Load the first series by default, so we don't have an empty plot

        $("#search").click();


		function showTooltip(x,y, contents) {
			$("<div id='tooltip'>" + contents + "</div>").css({
				position:"absolute",
				display:"none",
				top:y+5,
				left:x+5,
				border:"1px solid #fdd",
				padding: "2px",
				"background-color":"#fee",
				opacity:0.80
			}).appendTo("body").fadeIn(200);;
		}
		var previousPoint = null;
		$("#stationgraph").bind("plotclick", function( event, pos, item) {

			if ( item ) {
				if ( previousPoint != item.dataIndex ) {
					previousPoint = item.dataIndex;
					$('#tooltip').remove();
					x = item.datapoint[0];
					y = item.datapoint[1];
					showTooltip(item.pageX, item.pageY, item.series.label + " : " + x + "=" + y);
				}
			} else {
				$("#tooltip").remove();
				previousPoint = null;
			}
		});
    });

	</script>